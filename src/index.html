<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1"
  >

  <script type="module">
    const pos = (p) => `calc(${p}% - var(--half-line-width))`



const cssStyle = `
:root {
  --border-width: 12px;
  --border-radius: 12px;
  --border-color: red;
  --line-width: 4px;
  --half-line-width: calc(var(--line-width)/2);
  --quart-line-width: calc(var(--line-width)/4);
  --handler-height: 60px;
  --handler-width: calc(var(--line-width) * 2);
  --half-handler-width: calc(var(--handler-width)/2);
  --hover-factor:1.8;
}
jux-slider {

}
.wrapper {
  border: var(--border-width) solid var(--border-color);
  border-radius: var(--border-radius);
  margin: auto;
  height: 50vh;
  width: 50vw;
  box-sizing: border-box;
  position: relative;
  display: flex;
  background: var(--border-color);
  justify-content: space-between;
  align-items: stretch;
  overflow: hidden;
}
.left {
  border-radius: var(--border-radius) 0 0 var(--border-radius);
  width: calc(50% - var(--half-line-width));
  background-position: left;
}
.right {
  border-radius: 0 var(--border-radius) var(--border-radius) 0;
  flex-grow: 1;
  background-position: right;

  right: 0;
}
.left, .right {

  will-change: width;

}
.left .img, .right .img{
  background-size: cover;
  width: 100%;
  position: relative;
  height:100%;
  user-select: none;
}

.right .img {
  right: 0;
  background-position: right;
  z-index: 1;
  border-radius: 0 var(--border-radius) var(--border-radius) 0;

}
.clicked {
  transition: width 75ms ease-in-out;
}


.line {
  background: var(--border-color);
  width: var(--line-width);
  position:relative;
}
.grabber {
  width: var(--handler-width);
  height: var(--handler-height);
  background: var(--border-color);
}
.divide {
  position: relativ;
  width: 50px;
  height: 100%;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  transform: translate(calc(-50% + var(--half-line-width)));
  cursor: col-resize;
}
.arrow-left, .arrow-right {
  border-style: solid;
  width: 0;
  height: 0;
  transition: transform .2s ease;
  will-change: transform;
  z-index:  99;
}
.arrow-left {
  transform: translateX(calc(var(--line-width)* -1));
  border-width: 8px 8px 8px 0;
  border-color: transparent var(--border-color) transparent transparent;
}
.divide:hover .arrow-left {
  transform: translateX(calc(var(--line-width) * calc(var(--hover-factor) * -1)));
}
.arrow-right {
  transform: translateX(var(--line-width));
  border-width: 8px 0 8px 8px;
  border-color: transparent transparent transparent var(--border-color);
}
.divide:hover .arrow-right {
  transform: translateX(calc(var(--line-width) * var(--hover-factor)));
}
`

  const minMaxVal = (min, max, val) => Math.max(min, Math.min(max, val))
  const getOffsetOf = (elem) => {
    let x = 0
    do {
      x += elem.offsetLeft;
    } while (elem = elem.offsetParent);
    return x;
  }

  function offsetOfOn(mouse, elem) {

    const {pageX, clientX, buttons} = mouse
    if (!buttons) this.removeEventListener('mousemove', elem.updateMyHandler)

    let offset = getOffsetOf(elem.$wrapper)

    let fullWidth = elem.$wrapper.offsetWidth-2*elem.borderWidth;
    let x = clientX || pageX
    let posX =minMaxVal(0, fullWidth,  x-elem.borderWidth-offset);
    let percent =posX ? (posX/fullWidth) * 100 : 0
    console.log(percent)
    return percent
  }

  function updateHandlePositionOf(elem) {
    let requested = false
    return (mouse) => {
      if (requested) cancelAnimationFrame(requested);
      requested = requestAnimationFrame(()=> {
//        console.log(elem)
          setWidthOf(elem.$left, pos(offsetOfOn(mouse, elem)))
       })
      }
    }

  function setWidthOf(elem, newWidth) {
    elem.style.width = newWidth
  }

  class JuxSlider extends HTMLElement {

    constructor() {
      super();
      this.ref = {}
      this.innerHTML = this.render();
      this.updateMyHandler = updateHandlePositionOf(this)
      let leftImgSrc = this.getAttribute('left')
      let rightImgSrc = this.getAttribute('right')
  //    let left = this.querySelector(".left")
  //   let right = this.querySelector(".right")
      let leftImg = this.querySelector(".left .img")
      let rightImg = this.querySelector(".right .img")
      leftImg.style.backgroundImage = `url(${leftImgSrc})`;
      rightImg.style.backgroundImage = `url(${rightImgSrc})`;
      //   leftImg.src = leftImgSrc
      //   rightImg.src = rightImgSrc;
    }

    connectedCallback() {
      this.borderWidth = parseInt(getComputedStyle(this).getPropertyValue("--border-width"));
      this.$left = this.querySelector('.left')
      this.$wrapper = this.querySelector('.wrapper')
      let leftImg = this.querySelector(".left .img")
      let rightImg = this.querySelector(".right .img")

      let wrapperRect = getComputedStyle(this.$wrapper)
      console.log(wrapperRect.width, wrapperRect.height)
      leftImg.style.backgroundSize = wrapperRect.width;
      rightImg.style.backgroundSize = wrapperRect.width;
      this.addEventListener('mousedown', (mouse) => {
        let left = this.querySelector('.left')
        left.classList.add('clicked')
        this.updateMyHandler(mouse)
        setTimeout(()=>{
          left.classList.remove('clicked')
          this.addEventListener('mousemove', this.updateMyHandler)
        }, 75)
      })
      this.addEventListener('mouseup', () => {
        this.removeEventListener('mousemove', this.updateMyHandler)
      })

    }

    render() {
      return `<style>${cssStyle}</style>
    <div class="wrapper">
      <div class="left"><div class="img"></div></div>
      <div class="line">
        <div class="divide">
          <div class="arrow-left"></div>
          <div class="grabber"></div>
          <div class="arrow-right"></div>
        </div>
      </div>
      <div class="right"><div class="img"></div></div>
    </div>`
    }
  }
  customElements.define('jux-slider', JuxSlider);

  </script>
  <title>Jux</title>

</head>

<body>
  <jux-slider
    left="http://placekitten.com/g/600/700"
    right="https://placebear.com/g/600/700"
  ></jux-slider>

</body>

</html>
